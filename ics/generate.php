<?phprequire("../../config/database.php");require("../class/ics_unit.php");function getCount(){	$isi = fread(fopen("count.ini","r"),filesize("count.ini"));	fclose(fopen("count.ini","r"));	return $isi;}function getList($type){	$panjang = filesize("list.ini");	if($panjang>0){		$isi = fread(fopen("list.ini","r"),$panjang);		fclose(fopen("list.ini","r"));			if($type=='array'){			return explode("  ",$isi);		} else {			return $isi;		}	} else {		return 'Kosong';	}}function setValue($value, $type){	if($type=='count'){	  $tmp = fopen("count.ini", "w");			} elseif($type=='list') {	  $tmp = fopen("list.ini", "w");			}  fwrite($tmp,$value);  fclose($tmp);}function getformatingdate($date){	$tahun = $date[0].$date[1].$date[2].$date[3];	$bulan = $date[4].$date[5];	$tanggal = $date[6].$date[7];	return $tahun."-".$bulan."-".$tanggal;}function getrealdate($date){	return strtotime(getformatingdate($date));}$unit = new Ics_unit($db);if(getList('')=='Kosong'){	$arrv = array();	$show = $unit->showUnit();	while($data = $show->fetch(PDO::FETCH_OBJ)){		$arrv[] = $data->kd_unit." ".$data->kd_apt." ".$data->url_bnb;	}	setValue(implode("  ", $arrv),'list');	echo 'Get List Array';} else {	$unit_array = getList('array');	$jumlah_unit = count($unit_array);	$pointer = getCount();	if($pointer!=5){ //menit 29+1 menuju proses awal		//dalam jangkauan menit yang ditentukan		if($pointer<$jumlah_unit){			$data_unit = explode(" ", $unit_array[$pointer]); // 0:kd_unit; 1:kd_apt; 2:url_bnb;			$kd_unit = $data_unit[0];			date_default_timezone_set('Asia/Jakarta');			$sekarang = date('Y-m-d', strtotime('-90 Days'));			$current_trx = array();			$show2 = $unit->showRecent_trx($kd_unit, $sekarang);			while($data2 = $show2->fetch(PDO::FETCH_OBJ)){				$current_trx[] = $data2->check_in; 			}			$show2 = $unit->showRecent_booked($kd_unit, $sekarang);			while($data2 = $show2->fetch(PDO::FETCH_OBJ)){				$current_trx[] = $data2->check_in; 			}			require("../class/ics.php");			$ICS = new ICS($data_unit[2]);			$icsEvents = $ICS->cal_to_array();			for($i=0; $i<count($icsEvents); $i++){				$tmp_arr = $icsEvents[$i];				$check_in = getrealdate($tmp_arr['DTSTART;VALUE=DATE']);				$check_out = getrealdate($tmp_arr['DTEND;VALUE=DATE']);				if(!in_array(getformatingdate($tmp_arr['DTSTART;VALUE=DATE']), $current_trx) 					&& ($check_in>=strtotime($sekarang) || $check_out>=strtotime($sekarang))){					$kd_apt = $data_unit[1];					$penyewa_id = explode(' ', $tmp_arr['SUMMARY']);					$penyewa = str_replace(" ".$penyewa_id[count($penyewa_id)-1], "", $tmp_arr['SUMMARY']);					if(isset($tmp_arr['PHONE'])){						$no_tlp = $tmp_arr['PHONE'];						$check_in = getformatingdate($tmp_arr['DTSTART;VALUE=DATE']); 						$check_out = getformatingdate($tmp_arr['DTEND;VALUE=DATE']); 						$unit->createBooked($kd_unit, $kd_apt, $penyewa, $no_tlp, $check_in, $check_out);						//echo $kd_unit."><".$kd_apt."><".$penyewa."><".$no_tlp."><".$check_in."><".$check_out."<br>";					}				}			}		}		$pointer++;		setValue($pointer,'count');		echo 'hiutng';	} else {		//reset hitungan dan array		setValue('Kosong','list');		setValue('0','count');		echo 'reset';	}}?>